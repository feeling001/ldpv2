<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="004-fix-application-status-type" author="ldpv2-team">
        
        <!-- Drop existing table if it exists -->
        <sql>DROP TABLE IF EXISTS application CASCADE;</sql>
        
        <!-- Drop the enum type if it exists -->
        <sql>DROP TYPE IF EXISTS application_status CASCADE;</sql>
        
        <!-- Create application table with VARCHAR for status -->
        <createTable tableName="application">
            <column name="id" type="UUID" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="status" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="business_unit_id" type="UUID">
                <constraints nullable="false" 
                    foreignKeyName="fk_application_business_unit"
                    references="business_unit(id)"/>
            </column>
            <column name="end_of_life_date" type="DATE"/>
            <column name="end_of_support_date" type="DATE"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Create indexes -->
        <createIndex tableName="application" indexName="idx_application_status">
            <column name="status"/>
        </createIndex>

        <createIndex tableName="application" indexName="idx_application_business_unit">
            <column name="business_unit_id"/>
        </createIndex>

        <createIndex tableName="application" indexName="idx_application_name">
            <column name="name"/>
        </createIndex>

        <!-- Add check constraint to ensure valid status values -->
        <sql>
            ALTER TABLE application 
            ADD CONSTRAINT check_application_status 
            CHECK (status IN ('IDEA', 'IN_DEVELOPMENT', 'IN_SERVICE', 'MAINTENANCE', 'DECOMMISSIONED'));
        </sql>
        
    </changeSet>

    <!-- Insert sample applications in a separate changeset -->
    <changeSet id="004-insert-sample-applications-fixed" author="ldpv2-team">
        
        <!-- Insert sample applications -->
        <insert tableName="application">
            <column name="name" value="Customer Portal"/>
            <column name="description" value="External customer-facing portal for self-service"/>
            <column name="status" value="IN_SERVICE"/>
            <column name="business_unit_id" valueComputed="(SELECT id FROM business_unit WHERE name = 'Digital Services' LIMIT 1)"/>
            <column name="end_of_support_date" value="2028-12-31"/>
            <column name="end_of_life_date" value="2030-12-31"/>
        </insert>

        <insert tableName="application">
            <column name="name" value="Internal CRM"/>
            <column name="description" value="Customer relationship management system"/>
            <column name="status" value="IN_SERVICE"/>
            <column name="business_unit_id" valueComputed="(SELECT id FROM business_unit WHERE name = 'Digital Services' LIMIT 1)"/>
            <column name="end_of_support_date" value="2027-06-30"/>
            <column name="end_of_life_date" value="2029-06-30"/>
        </insert>

        <insert tableName="application">
            <column name="name" value="HR Management System"/>
            <column name="description" value="Employee data and payroll management"/>
            <column name="status" value="IN_SERVICE"/>
            <column name="business_unit_id" valueComputed="(SELECT id FROM business_unit WHERE name = 'Human Resources' LIMIT 1)"/>
            <column name="end_of_support_date" value="2029-12-31"/>
            <column name="end_of_life_date" value="2031-12-31"/>
        </insert>

        <insert tableName="application">
            <column name="name" value="Financial Reporting Tool"/>
            <column name="description" value="Automated financial reporting and analytics"/>
            <column name="status" value="IN_SERVICE"/>
            <column name="business_unit_id" valueComputed="(SELECT id FROM business_unit WHERE name = 'Finance' LIMIT 1)"/>
            <column name="end_of_support_date" value="2026-12-31"/>
            <column name="end_of_life_date" value="2028-12-31"/>
        </insert>

        <insert tableName="application">
            <column name="name" value="Mobile App"/>
            <column name="description" value="Customer mobile application"/>
            <column name="status" value="IN_DEVELOPMENT"/>
            <column name="business_unit_id" valueComputed="(SELECT id FROM business_unit WHERE name = 'Digital Services' LIMIT 1)"/>
        </insert>

        <insert tableName="application">
            <column name="name" value="Legacy Inventory System"/>
            <column name="description" value="Old inventory management system - to be decommissioned"/>
            <column name="status" value="MAINTENANCE"/>
            <column name="business_unit_id" valueComputed="(SELECT id FROM business_unit WHERE name = 'Operations' LIMIT 1)"/>
            <column name="end_of_life_date" value="2026-06-30"/>
        </insert>

        <insert tableName="application">
            <column name="name" value="AI Analytics Platform"/>
            <column name="description" value="Machine learning based analytics platform"/>
            <column name="status" value="IDEA"/>
            <column name="business_unit_id" valueComputed="(SELECT id FROM business_unit WHERE name = 'Digital Services' LIMIT 1)"/>
        </insert>
        
    </changeSet>
    
</databaseChangeLog>